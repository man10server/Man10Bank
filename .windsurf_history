## 問題
`StringFormat.money(BigDecimal)` が `toLong()` によりオーバーフローの可能性。カンマ区切りがロケール依存。

## 原因分析
- BigDecimal -> long 変換で範囲外になるケースがある。
- Locale 未指定のため区切り文字が環境依存。

## 修正内容
- `toBigInteger()` を使用。
- `String.format(Locale.US, "%,d", ...)` に変更。
- 必要な import を追加。

## 期待される結果
- BigDecimal から小数部切り捨ての整数を 3 桁カンマで返す。
- 大きな数値でも安全に表示可能。
- 例: 1234567.89 -> "1,234,567"

## 問題
テーブル定義（`db/tables/*.kt`）は double 型のまま維持したいが、Repository が BigDecimal を前提に変更されておらず型不一致が発生。

## 原因分析
- `UserBank.balance` などは `double("...")` だが、Repository 側で Double ⇄ BigDecimal の変換をしていない箇所があった。

## 修正内容
- `UserBank.kt` は double のまま（差分なし）。
- `BankRepository.getBalanceByUuid` で取得 Double? -> `BigDecimal` へ変換（`RoundingMode.DOWN`）。
- `BankRepository.setBalance` で保存時 `BigDecimal` -> `Double` に変換。
- `BankRepository.logMoney` で保存時 `BigDecimal` -> `Double` に変換。

## 期待される結果
- 外部（サービス層）は BigDecimal で安全に扱い、DB は double に保存。
- 端数は常に切り捨て（RoundingMode.DOWN）。

## 問題
金額カラムを DOUBLE から DECIMAL(20,0) へ移行（精度確保・誤差排除）。

## 原因分析
- 金額に浮動小数点を使っており誤差が蓄積する恐れ。
- 既存テーブルの金額カラムが DOUBLE。

## 修正内容
- Ktorm テーブルモデルで `double("...")` -> `decimal("...")` に置換。
  - `user_bank.balance`
  - `money_log.amount`
  - `atm_log.amount`
  - `cheque_tbl.amount`
  - `server_loan_tbl.borrow_amount`, `server_loan_tbl.payment_amount`
  - `loan_table.amount`
  - `estate_tbl.{vault,bank,cash,estate,loan,shop,crypto,total}`
  - `estate_history_tbl.{vault,bank,cash,estate,loan,shop,crypto,total}`
  - `server_estate_history.{vault,bank,cash,estate,loan,shop,crypto,total}`
- 金額は整数運用（scale=0）。サービス/Repoで `setScale(0, RoundingMode.DOWN)` で正規化。
- MySQL 移行 SQL `src/main/sql/001_decimal_migration.sql` を追加。
  - `*_new DECIMAL(20,0)` 追加 → `TRUNCATE(...)` でコピー → 旧カラム DROP → リネーム。

## 期待される結果
- すべての金額が DECIMAL(20,0) で保持され、丸め誤差が排除される。
- 端数は常に切り捨てで一貫。

## 問題
Vault 連携の入出金処理が BigDecimal に未対応で、二重丸めや精度劣化の懸念がある。

## 原因分析
- Vault API は `double` ベースのため、プロジェクト標準の `BigDecimal` と直接整合しない。
- 大きな金額の場合、`double` 変換で正確性を失う可能性がある。

## 修正内容
- `src/main/java/red/man10/man10bank/vault/VaultEconomyService.kt` を新規追加。
  - 内部は `BigDecimal` を使用し、Vault 呼び出し直前のみ `double` へ変換。
  - 金額は `setScale(0, RoundingMode.DOWN)` で整数化してから変換。
  - 2^53-1 を超える場合はエラーで拒否（`double` 整数表現の限界対策）。
  - `getBalance`/`deposit`/`withdraw`/`has`/`format` を提供。

## 期待される結果
- プロジェクト内の金額は常に `BigDecimal` で安全に扱われ、Vault 連携時の精度劣化を回避。
- 入出金と残高取得が一貫した丸め規則（切り捨て）で動作する。

## 問題
`VaultEconomyService` がコンストラクタで即座に Vault を要求し、未導入環境で例外となる。また金額の正数判定に `signum()` を使用しており、プロジェクトの比較スタイルと不一致。

## 原因分析
- デフォルト引数で `resolveEconomyOrThrow()` を呼び出していたため、初期化時に例外化。
- 比較記法は BigDecimal 演算子（`>`/`<=`）で統一する方針だった。

## 修正内容
- `VaultEconomyService` のコンストラクタを `private val economy: Economy` に変更（外部注入）。
- `resolveEconomyOrThrow` を `resolveEconomy(): Economy?` に変更し、Vault プラグインと登録の存在確認をして `null` を返す安全実装に。
- `deposit`/`withdraw`/`has` の `signum()` 判定を `BigDecimal.ZERO` との比較へ置き換え。

## 期待される結果
- Vault 未導入環境でも例外にならず、呼び出し側で可否判定が可能。
- 金額比較スタイルがプロジェクト方針に統一され可読性が向上。
